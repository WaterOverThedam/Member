<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>活动</title>
    <link rel="stylesheet" href="/css/sm.min.css"/>
    <link rel="stylesheet" href="/css/animate.css"/>
    <link rel="stylesheet" href="/css/activities.css"/>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
    <script src="/js/gym.js" type="text/javascript"></script>
    <script src="http://api.map.baidu.com/api?v=1.5&ak=PYOyYyKG6YV0kCbhf4F8uDpVSHDCc2HI" type="text/javascript"></script>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet"/>

</head>

<body>
<div id="bdMapBox" style="display:none;"></div>
<div id="box">
<div class="page-group box" data-value="">

    <div class="page page-current" id="home">
        <header class="bar bar-nav">
            <a class="button button-link pull-left "><i class="fa fa-location-arrow" aria-hidden="true"></i>
                <small>我的位置：<label class="mycity"></label></small>
            </a>
            <a class="button button-link  fa fa-user pull-right " href="#myinfo"></a>
            <a class="button button-link  fa fa-search  pull-right " href="#search"></a>
            <a class="button button-link  fa fa-home  pull-right active" href="javascript:;"></a>
        </header>
        <div class="content  pull-to-refresh-content infinite-scroll infinite-scroll-bottom">
            <div class="pull-to-refresh-layer">
                <div class="preloader"></div>
                <div class="pull-to-refresh-arrow"></div>
            </div>

            <div class="card-container">
                <!--<div class="card">
                    <div class="card-header no-border no-padding">
                        <img class="card-cover" src="images/inform.jpg" /></div>
                    <div class="card-content">
                        <div class="card-content-inner">
                            <div class="gym-activity-title">
                                奇怪的植树节活动
                            </div>
                            <div class="gym-activity-item">
                                <div class="avitivity-text">
                                    <p>日期: 2017-12-12 ~ 2017-12-22</p>
                                    <p>运动: 轮滑</p>
                                </div>
                                <i class="fa fa-bicycle fa-2x text-primary" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>-->
            </div>
            <!-- 加载提示符 -->
            <div class="infinite-scroll-preloader">
                <div class="preloader"></div>
            </div>
        </div>
        <div class="fixed-selected  open-panel">
            <i class="fa fa-university fa-2x" aria-hidden="true"></i>
        </div>
    </div>

    <div class="page" id="activity" data-value="">
        <header class="bar bar-nav">
            <a class="button button-link pull-left "><i class="fa fa-location-arrow" aria-hidden="true"></i>
                <small>我的位置：<label class="mycity"></label></small>
            </a>
            <a class="button button-link  fa fa-user pull-right active" href="#myinfo"></a>
            <a class="button button-link  fa fa-search  pull-right " href="#search"></a>
            <a class="button button-link  fa fa-home  pull-right " href="#home"></a>
        </header>
        <div class="content">
            <div class="card">
                <div class="card-content gym-activity" id="activity_banner">
                    <a href="#home"><i class="fa fa-angle-double-left fa-3x"></i></a>
                    <div class="gym-title" id="activity_name">获取中...</div>

                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <div class="row">
                        <div class="col-25">
                            <div class="icon-item" id="icon-like">
                                <i class="fa fa-heart-o fa-2x"></i>
                                <p>喜欢</p>
                            </div>
                        </div>
                        <div class="col-25">
                            <div class="icon-item" id="icon-apply">
                                <i class="fa fa-file-text fa-2x"></i>
                                <p>参加</p>
                            </div>
                        </div>
                        <div class="col-25">
                            <div class="icon-item" id="icon-rule">
                                <i class="fa fa-reorder fa-2x"></i>
                                <p>细则</p>
                            </div>
                        </div>
                        <div class="col-25">
                            <div class="icon-item" id="icon-review">
                                <i class="fa fa-photo fa-2x"></i>
                                <p>回顾</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="rule">
                <div class="card-header gym-card-title">
                    <i></i>
                    <div class="">活动细则</div>
                    <i></i>
                </div>
                <div class="card-content">
                    <div class="row no-gutter">
                        <div class="col-50">
                            <div class="rule-title">活动时间：<label class="rule-text" id="activity_beginDate">获取中...</label>
                            </div>
                        </div>
                        <div class="col-50">
                            <div class="rule-title">活动类别：<label class="rule-text" id="activity_type">获取中...</label>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutter">
                        <div class="col-50">
                            <div class="rule-title">收费类型：<label class="rule-text"
                                                                id="activity_chargeType">获取中...</label></div>
                        </div>
                        <div class="col-50">
                            <div class="rule-title">针对人群：<label class="rule-text" id="activity_crowd">获取中...</label>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutter">
                        <div class="col-50">
                            <div class="rule-title">运动强度：<label class="rule-text" id="activity_strength">获取中...</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="detail">
                <div class="card-header gym-card-title">
                    <i></i>
                    <div>活动详情</div>
                    <i></i>
                </div>
                <div class="card-content">
                    <div class="activity-detail" id="activity_detail">
                        获取中...
                    </div>
                </div>
            </div>
            <div class="content-block-title">
                <a id="add" href="#"><i class="fa fa-plus-square-o" aria-hidden="true"></i>&nbsp;报名名单</a>
            </div>
            <div class="card" id="apply">
                <div class="card-content">

                    <div class="list-block">
                        <ul>
                            <li  class="item-content item-link" v-for="p in participators" @click="edit(p.name,p.familyTitle,p.id)">
                                <div class="item-media">
                                    <i class="icon icon-edit"></i>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title"><i class="fa fa-user"></i>{{p.name}}</div>
                                    <div class="item-after">{{p.familyTitle}}</div>
                                </div>
                            </li>
                        </ul>
                    </div>


                </div>
                <div class="card-footer">
                    <div v-show="enrollStatus==0" class="gym-checkbox"><label><input id="agree" type="checkbox" />我已阅读活动内容及规则</label>
                    </div>
                    <a class="button button-fill " id="pickerActivity" href="javascript:;">报名</a>
                </div>
            </div>

        </div>
    </div>

    <div class="page" id="search">
        <header class="bar bar-nav">
            <a class="button button-link pull-left "><i class="fa fa-location-arrow" aria-hidden="true"></i>
                <small>我的位置：<label class="mycity"></label></small>
            </a>
            <a class="button button-link  fa fa-user pull-right " href="#myinfo"></a>
            <a class="button button-link  fa fa-search  pull-right active" href="#search"></a>
            <a class="button button-link  fa fa-home  pull-right " href="#home"></a>
        </header>
        <div class="bar bar-header-secondary">
            <form name="searchForm" action="/activity/search" method="post" onsubmit="return submitSearch()">
                <div class="searchbar">
                    <a class="searchbar-cancel">取消</a>
                    <div class="search-input">
                        <label class="search-fa fa fa-search" aria-hidden="true" for="search"></label>
                        <input type="search" id='keyword' placeholder='输入关键字...'/>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="page" id="myinfo">
        <header class="bar bar-nav">
            <a class="button button-link pull-left "><i class="fa fa-location-arrow" aria-hidden="true"></i>
                <small>我的位置：<label class="mycity"></label></small>
            </a>
            <a class="button button-link  fa fa-user pull-right active" href="#myinfo"></a>
            <a class="button button-link  fa fa-search  pull-right " href="#search"></a>
            <a class="button button-link  fa fa-home  pull-right " href="#home"></a>
        </header>
        <div class="content">
            <div class="content-block-title">个人信息</div>
            <div class="list-block">
                <ul>
                    <li class="item-content item-link" id="info">
                        <div class="item-inner">
                            <div class="item-title">姓名</div>
                            <div class="item-after">地址</div>
                        </div>
                    </li>
                    <li class="item-content item-link">
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" placeholder="" value="上海 浦东新区" id="city-picker" readonly=""/></div>
                            <div class="item-after" id="changeCity">修改城市</div>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="content-block-title">已报名的活动，共<label class="text-danger">1</label>个活动</div>
            <div class="list-block">
                <ul>
                    <a class="item-content item-link" href="#activity">
                        <div class="item-inner">
                            <div class="item-title">植树节</div>
                            <div class="item-after">查看</div>
                        </div>
                    </a>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="popup popup-add box">
    <div class="content">
        <h3 class="apply-title text-center">
            报名信息
        </h3>
        <div class="list-block">
            <ul>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-user fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="add_name" v-model="candidate.name" placeholder="姓名"/>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-phone fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="role" v-model="candidate.title" placeholder="孩子/家长"/>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="content-block">
            <div class="row">
                <div class="col-50"><a href="javascript:;"
                                       class="button button-big button-fill button-danger close-popup">取消</a></div>
                <div class="col-50"><a id="add_submit" href="javascript:;"
                                       class="button button-big button-fill button-success">提交</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="popup popup-update">
    <div class="content">
        <h3 class="apply-title text-center">报名信息</h3>
        <div class="list-block">
            <ul>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-user fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="update_name" data-id="" placeholder="姓名"/>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-phone fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="update_role" placeholder="孩子/家长"/>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="content-block">
            <div class="row">
                <div class="col-50"><a href="javascript:;"
                                       class="button button-big button-fill button-danger close-popup">取消</a></div>
                <div class="col-50"><a id="update_submit" href="javascript:;"
                                       class="button button-big button-fill button-success">提交</a>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="popup popup-profile box">
    <div class="content">
        <h3 class="apply-title text-center">家庭信息{{user.familyName}}</h3>
        <div class="list-block">
            <ul>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-user fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="add_name" v-model="user.familyName" placeholder="姓名"/>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-phone fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="add_phone" v-model="user.tel" placeholder="联系电话"/>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="fa fa-phone fa-2x"></i></div>
                        <div class="item-inner">
                            <div class="item-input">
                                <input type="text" id="role" v-model="user.familyTitle" placeholder="孩子/家长"/>
                            </div>
                        </div>
                    </div>
                </li>

            </ul>
        </div>
        <div class="content-block">
            <div class="row">
                <div class="col-50"><a href="javascript:;"
                                       class="button button-big button-fill button-danger close-popup">取消</a></div>
                <div class="col-50"><a id="add_submit" href="javascript:;"
                                       class="button button-big button-fill button-success">提交</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel panel-right panel-reveal panel-selected">
    <div class="content-block">
        <p>活动筛选</p>
        <p>
            <small>请选择筛选的活动门店</small>
        </p>
        <!-- Click on link with "close-panel" class will close panel -->
        <div class="list-block">
            <ul>
                <li><a href="javascript:;" class="item-link list-button">确定</a></li>
                <li><a href="javascript:;" class="item-link list-button close-panel color-gray">取消</a></li>
            </ul>
        </div>

    </div>

</div>
</div>
<script type='text/javascript' src='/js/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/sm-city-picker.min.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/vue.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/vue-resource.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/activity.js' charset='utf-8'></script>

<script>
  var url_add = "https://bbk.800app.com/uploadfile/staticresource/238592/279833/dataInterface_jsonp.aspx";
  var url_edit = "https://bbk.800app.com/uploadfile/staticresource/238592/279833/dataInterface_jsonp.aspx";

  window.onload=function(){
        var vm = new Vue({
            el:'#box',
            data:{
                actId:"",
                user: {},
                participators: [],
                candidate: {name:"",title:""},
                enrollStatus:0
            },
            created: function () {
                this.getProfile();
            },
            computed:{
                names:{
                    get:function(){
                        var arr =[];
                        $.each(this.participators,function (i,item) {
                             arr.push(item.name)
                        })
                        return arr;
                    }
                }

            },
            filters: {
                max: {
                    read: function (value) {
                        var arr=value.split(",");
                        return Math.max.apply(null,arr);
                    }
                },
                min: {
                    read: function (value) {
                        var arr=value.split(",");
                        return Math.min.apply(null,arr);
                    }

                }
            },
            methods:{
                //1：报名；0：取消/未报名；3：预报名
                checkEnrollStatus:function () {
                    //alert(this.user.id)
                    this.$http.get('/activity/checkEnrol',
                        {actId:this.actId, userId:this.user.id}
                    ).then(function(res){
                        this.enrollStatus = res.data;
                        if(res.data==1){
                            $("#pickerActivity").text("我已报名");
                            if (!$("#pickerActivity").hasClass("disabled")){
                                $("#pickerActivity").toggleClass("disabled");
                            }
                        }else{
                            //$("#pickerActivity").removeClass("disabled");
                            $("#pickerActivity").text("我要报名");
                        }
                    },function(res){
                        console.log(res.status);
                    });

                },
                getProfile:function(){
                    this.$http.get('/index/profile').then(function(res){
                        this.user = res.data
                    },function(res){
                        console.log(res.status);
                    });
                },
                getCandidate:function(){
                    this.$http.get('/activity/getCandidate',{
                        userId: this.user.id,
                        names: this.names
                    }).then(function(res){
                        if(res.data){
                           this.candidate.name = res.data[0].familyName;
                           this.candidate.title = res.data[0].familyTitle;
                        }
                    },function(res){
                        alert(res.status);
                    });
                },
                getPar:function(){
                    this.$http.get('/activity/getPar',{
                        userId:this.user.id,
                        actId: this.actId
                    }).then(function(res){
                        if(res){
                           this.participators =res.data;
                        }
                        //alert(JSON.stringify(this.participators));
                    },function(res){
                        alert(res.status);
                    });
                },
                edit: function (name,title,id) {
                    name = name||"";
                    title =title||"";
                    id =id||"";
                    var buttons1 = [
                        {
                            text: '请选择',
                            label: true
                        },
                        {
                            text: '修改',
                            onClick: function () {
                                $("#update_name").val(name);
                                $("#update_name").data("id",id);
                                $("#update_role").val(title)
                                $.popup('.popup-update');
                            }
                        },
                        {
                            text: '删除',
                            bold: true,
                            color: 'danger',
                            onClick: function () {
                                this.$http.get('/activity/delPar',{
                                    idPar: id,
                                }).then(function(res){
                                    if(!res.code){
                                        this.getPar();
                                    }
                                },function(res){
                                    alert(res.status);
                                });
                            }
                        }
                    ];
                    var buttons2 = [
                        {
                            text: '取消',
                            bg: 'danger'
                        }
                    ];
                    var groups = [buttons1, buttons2];
                    $.actions(groups);
                },
                enroll:function () {
                    this.$http.get('/activity/enrol',{
                        actId: this.actId
                    }).then(function(res){
                        $.toast(res.msg);
                        //alert(JSON.stringify(this.participators));
                    },function(res){
                        alert(res.status);
                    });


                }

            }
    });


    $(document).on("pageInit", function (e, pageId, $page) {
        if(pageId == 'activity'){
            actId = $("#activity").data("value");
            if(actId && actId!=""){
               vm.actId = actId;
            }
            //界面信息初始化
           // vm.getCandidate();
            vm.getPar();
            ajax_activity(actId)
            //更新报名状态
            vm.checkEnrollStatus();


            //1：报名；0：取消；3：预报名
            $("#pickerActivity").on('click', function () {
                if(vm.enrollStatus==1){
                    return false;
                }
                if (!$(this).hasClass("disabled")) {
                    $("#activity").data("status",3);
                    if(vm.participators.length == 0){
                        $.confirm('请先填写报名信息', function () {
                            vm.getCandidate();
                            $.popup('.popup-add');
                        });
                    }else {
                        vm.enrol();
                    }
                } else {
                    //alert(1)
                    $.alert("请先阅读活动内容及规则！")
                }

            });
            //绑定事件
            $("#add_submit").click(function () {
                if(pageId == 'myinfo'){
                    //user的信息
                    alert(actId)
                    return 1;
                }
                if(checkAdd()){
                    $.ajax({
                        type: 'POST',
                        url: '/activity/add',
                        data: {
                            'name': $("#add_name").val(),
                            'tel': $("#add_phone").val(),
                            'familyTitle': $("#role").val(),
                            'actId': actId
                        },
                        async: false,
                        contentType: "application/x-www-form-urlencoded",
                        dataType: "json",
                        success: function (res) {
                            if (res.code) {
                                $.toast(res.msg)
                                $.closeModal(".popup-add");
                            }else {
                                vm.participators.push(res.data)
                                if ($("#activity").data("status") == 3){
                                    var modal = $.modal({
                                        title: '报名信息添加成功！',
                                        text: '是否还有其他人参与活动？',
                                        buttons: [
                                            {
                                                text: '没有，开始报名',
                                                bold: true,
                                                onClick: function () {
                                                    vm.enroll();
                                                    vm.getPar();
                                                    $.closeModal(modal)
                                                    $.closeModal(".popup-add");
                                                    $("#activity").data("status", 1)
                                                }
                                            },
                                            {
                                                text: '有，继续登记',
                                                bold: true,
                                                onClick: function () {
                                                    vm.getCandidate()
                                                    $.popup('.popup-add');

                                                }
                                            },
                                        ]
                                    })
                                }else {
                                    var modal = $.modal({
                                        title: '报名信息添加成功',
                                        text: '是否还有其参与人员？',
                                        buttons: [
                                            {
                                                text: '没有了，完成',
                                                bold: true,
                                                onClick: function () {
                                                    $.closeModal(".popup-add");
                                                }
                                            },
                                            {
                                                text: '有，继续登记',
                                                bold: true,
                                                onClick: function () {
                                                    $.popup('.popup-add');
                                                }
                                            },
                                        ]
                                    })

                                }

                            }
                        }
                    })
                }
            })
        }


    });
    $.init()

};
    
</script>
</body>

</html>